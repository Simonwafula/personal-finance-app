# OpenLiteSpeed Virtual Host Configuration
# Domain: finance.mstatilitechnologies.com
# Location: /usr/local/lsws/conf/vhosts/finance.mstatilitechnologies.com/vhconf.conf
# Or configure via CyberPanel GUI
#
# Structure:
#   /home/mstatilitechnologies.com/
#   ├── .env                    # Django environment
#   ├── .venv/                  # Python virtual environment  
#   ├── logs/                   # Gunicorn logs
#   └── public_html/            # Document root (Git root)
#       ├── manage.py
#       ├── backend/
#       ├── client/
#       │   └── dist/           # Built React app (index.html here)
#       └── staticfiles/        # Django collected static

docRoot                   $VH_ROOT/public_html/client/dist
vhDomain                  finance.mstatilitechnologies.com
vhAliases                 www.finance.mstatilitechnologies.com
adminEmails               admin@mstatilitechnologies.com
enableGzip                1
enableBr                  1

# Index files
index  {
  useServer               0
  indexFiles              index.html
  autoIndex               0
}

# Error pages
errorlog $VH_ROOT/logs/error.log {
  useServer               0
  logLevel                WARN
  rollingSize             10M
}

accesslog $VH_ROOT/logs/access.log {
  useServer               0
  logFormat               "%h %l %u %t \"%r\" %>s %b"
  rollingSize             10M
  keepDays                30
  compressArchive         1
}

# Script handlers (if needed)
scripthandler  {
  add                     lsapi:lsphp81 php
}

# External App - Gunicorn/Django Backend
extprocessor django {
  type                    proxy
  address                 127.0.0.1:8001
  maxConns                100
  pcKeepAliveTimeout      60
  initTimeout             60
  retryTimeout            0
  respBuffer              0
}

# Context for Django API
context /api/ {
  type                    proxy
  handler                 django
  addDefaultCharset       off
}

# Context for Django Admin
context /admin/ {
  type                    proxy
  handler                 django
  addDefaultCharset       off
}

# Context for React Assets (MUST come before Django proxy)
context /assets/ {
  type                    NULL
  location                $DOC_ROOT/assets/
  allowBrowse             1

  extraHeaders            <<<END_HEADERS
Cache-Control: public, max-age=31536000, immutable
END_HEADERS
}

# Context for favicon
context /favicon.svg {
  type                    NULL
  location                $DOC_ROOT/favicon.svg
  allowBrowse             1
}

# Context for other root files
context exp ^/(robots\.txt|manifest\.json|favicon\.ico)$ {
  type                    NULL
  location                $DOC_ROOT/$0
  allowBrowse             1
}

# Context for Django Auth (Google OAuth)
context /accounts/ {
  type                    proxy
  handler                 django
  addDefaultCharset       off
}

# Context for Django Static Files (if not using WhiteNoise)
context /static/ {
  type                    proxy
  handler                 django
  addDefaultCharset       off
}

# Rewrite rules for React SPA
rewrite  {
  enable                  1
  autoLoadHtaccess        1
  
  rules                   <<<END_RULES
# Force HTTPS
RewriteCond %{HTTPS} !on
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# React SPA fallback - serve index.html for non-file routes
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/admin/
RewriteCond %{REQUEST_URI} !^/accounts/
RewriteCond %{REQUEST_URI} !^/static/
RewriteRule ^(.*)$ /index.html [L]
END_RULES
}

# Security headers
context / {
  type                    NULL
  location                $DOC_ROOT/
  allowBrowse             1
  
  extraHeaders            <<<END_HEADERS
X-Frame-Options SAMEORIGIN
X-Content-Type-Options nosniff
X-XSS-Protection 1; mode=block
Referrer-Policy strict-origin-when-cross-origin
END_HEADERS
}
