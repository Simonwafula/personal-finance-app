# OpenLiteSpeed .htaccess for React SPA with Django API
# Place this in: /home/finance.mstatilitechnologies.com/public_html/.htaccess
# 
# Structure:
#   /home/finance.mstatilitechnologies.com/
#   ├── .env                    # Django environment
#   ├── .venv/                  # Python virtual environment
#   ├── logs/                   # Gunicorn logs
#   └── public_html/            # Git root (Django + React)
#       ├── manage.py
#       ├── backend/
#       ├── client/
#       │   └── dist/           # Built React app
#       └── .htaccess           # This file
#
# NOTE: Proxying to Django (/api/, /admin/, /accounts/, /static/) is handled
# by OLS vhost context blocks, NOT .htaccess rewrite rules.
# OLS does NOT support the [P] proxy flag in rewrite rules.

# Enable rewrite engine
RewriteEngine On

# Force HTTPS (uncomment in production)
# RewriteCond %{HTTPS} !on
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# ============================================
# Django Backend Routes - SKIP (handled by OLS contexts)
# ============================================
# These paths are proxied to Django via OLS vhost context blocks:
# - /api/*      -> django extprocessor (127.0.0.1:8001)
# - /admin/*    -> django extprocessor (127.0.0.1:8001)
# - /accounts/* -> django extprocessor (127.0.0.1:8001)
# - /static/*   -> django extprocessor (127.0.0.1:8001)

# ============================================
# React SPA - Serve from client/dist/
# ============================================

# Serve React assets from client/dist/assets/
RewriteRule ^assets/(.*)$ client/dist/assets/$1 [L]

# Serve favicon and other root files from client/dist/
RewriteCond %{REQUEST_URI} ^/(favicon\.ico|robots\.txt|manifest\.json)$
RewriteRule ^(.*)$ client/dist/$1 [L]

# For all other non-file, non-directory requests, serve React's index.html
# Skip paths handled by OLS contexts (Django backend)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/admin/
RewriteCond %{REQUEST_URI} !^/accounts/
RewriteCond %{REQUEST_URI} !^/static/
RewriteRule ^(.*)$ client/dist/index.html [L]

# ============================================
# Security Headers
# ============================================

<IfModule mod_headers.c>
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# ============================================
# Caching for Static Assets
# ============================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML - no cache (let React handle versioning)
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ============================================
# Compression
# ============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
    AddOutputFilterByType DEFLATE application/javascript application/json
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>
